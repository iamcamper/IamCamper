<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iamcamper.boot_imc.mapper.AdminMapper">

<!-- 게시글과 댓글을 담는 resultMap -->
<resultMap type="com.iamcamper.boot_imc.VO.BbsVO" id="listMap">
  <id property="b_idx" column="b_idx"/>
  <collection property="c_list" ofType="com.iamcamper.boot_imc.VO.CommVO" 
  select="com.iamcamper.boot_imc.mapper.CommMapper.commList"
  column="b_idx"></collection>
</resultMap>

<!-- login 기능 -->
    <select id="login" resultType="com.iamcamper.boot_imc.VO.MemVO" parameterType="Map">
    SELECT * FROM member
    WHERE id = #{id} AND pw = #{pw} AND grade = #{grade}
    </select>

<!-- 전체 게시글의 수 반환 -->
    <select id="totalCount" resultType="int" parameterType="String">
    SELECT COUNT(*) FROM bbs
    WHERE bname = #{bname} AND status = 0
    </select>

<!-- 해당 게시글 페이징 기법으로 반환 -->
    <select id="list" resultMap="listMap" parameterType="Map">
    SELECT a.* FROM (
      SELECT @RN:=@RN+1 AS rownum, b.* FROM(
        SELECT * FROM bbs WHERE bname = #{bname} AND status = 0 ORDER BY b_idx DESC) b,
        (SELECT @RN:=0) r
      ) a
    WHERE rownum BETWEEN #{begin} AND #{end}
    </select>

<!-- 게시글 등록 -->
    <insert id="write" parameterType="com.iamcamper.boot_imc.VO.BbsVO">
    INSERT INTO bbs(nickname ,subject, content, file_name, ori_name, thum_img, write_date, ip, bname)
    VALUES (#{nickname}, #{subject}, #{content}, #{file_name}, #{ori_name}, #{thum_img}, NOW(), #{ip}, #{bname})
    </insert>

<!-- 배너 게시판 카운트 -->
<select id="bannerCount" parameterType="Map" resultType="int">
    SELECT COUNT(*) FROM bbs
    WHERE bname IN (#{bname1}, #{bname2}) AND status = 0
</select>

<!-- 배너 게시판 게시글 리스트 불러오기 -->
    <select id="bannerList" parameterType="Map" resultMap="listMap">
    SELECT a.* FROM (
      SELECT @RN:=@RN+1 AS rownum, b.* FROM(
        SELECT * FROM bbs WHERE bname IN (#{bname1}, #{bname2}) AND status = 0 ORDER BY b_idx DESC) b,
        (SELECT @RN:=0) r
      ) a
    WHERE rownum BETWEEN #{begin} AND #{end}
    </select>

<!-- 클릭한 게시글 불러오기 -->
  <select id="views" parameterType="String" resultMap="listMap">
    SELECT * FROM bbs
    WHERE b_idx = #{b_idx}
  </select>

<!-- 게시글 업데이트 문 -->
  <update id="bbsEdit" parameterType="Map">
    UPDATE bbs SET subject = #{subject}, content = #{content}, file_name = #{file_name}, ori_name = #{ori_name}
    WHERE b_idx = #{b_idx}
  </update>

<!-- 조회수 update 문-->
  <update id="viewCount" parameterType="String">
    UPDATE bbs SET hit = hit + 1
    WHERE b_idx = #{b_idx}
  </update>

<!-- 대시보드 오늘 가입한 회원 수 -->
  <select id="todayRegCount" resultType="int">
    SELECT COUNT(*) FROM member
    WHERE reg_date = DATE_FORMAT(NOW(), '%Y-%m-%d')
    AND activate = 0
  </select>
  
<!-- 대시보드 전체 게시판별 토탈 게시글 수 -->
  <select id="bbsTotalCnt" resultType="com.iamcamper.boot_imc.VO.BbsTotalCntVO">
    SELECT bname, COUNT(*) AS cnt FROM bbs 
    WHERE status = 0 AND write_date = DATE_FORMAT(NOW(), '%Y-%m-%d') 
    GROUP BY bname
  </select>

<!-- 대시보드 회원 가입 인원 카운트 수-->
  <select id="regCnt" resultType="com.iamcamper.boot_imc.VO.RegCntVO">
    SELECT reg_date, COUNT(*) as cnt FROM member 
    GROUP BY reg_date
    ORDER BY reg_date desc
    LIMIT 5;
  </select>

<!-- 대시보드 전체 회원 가입 인원 구하기-->
  <select id="memberCnt" resultType="int">
    SELECT COUNT(*) FROM member
    WHERE grade = 0 AND activate = 0
  </select>

<!-- 게시판별 글 검색 페이징 기법으로 반환 -->
  <select id="bbsList" parameterType="Map" resultMap="listMap">
  SELECT a.* FROM (
      SELECT @RN:=@RN+1 AS rownum, b.* FROM(
        SELECT * FROM bbs WHERE status = 0 
        <if test = 'category.equals("nickname")'>
        AND nickname LIKE CONCAT ('%', #{value}, '%')
        AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
        </if>
        <if test = "category.equals('bname')">
          AND bname = #{value}
        </if>
        <if test = "category.equals('write_date')">
          AND write_date = #{value}
          AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
        </if>
        <if test = "category.equals('subject')">
          AND subject LIKE CONCAT ('%', #{value}, '%')
          AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
        </if>
        <if test = "category.equals('content')">
          AND content LIKE CONCAT ('%', #{value}, '%')
          AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
        </if>
        ORDER BY b_idx DESC) b,
        (SELECT @RN:=0) r
      ) a
    WHERE rownum BETWEEN #{begin} AND #{end}
  </select>

  <!-- 게시판별 글 갯수 카운트 -->
  <select id="bbsCount" parameterType="Map" resultType="int">
    SELECT COUNT(*) FROM bbs
    WHERE status = 0 
      <if test = 'category.equals("nickname")'>
        AND nickname LIKE CONCAT ('%', #{value}, '%')
        AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
      </if>
      <if test = "category.equals('bname')">
        AND bname = #{value}
      </if>
      <if test = "category.equals('write_date')">
        AND write_date = #{value}
        AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
      </if>
      <if test = "category.equals('subject')">
        AND subject LIKE CONCAT ('%', #{value}, '%')
        AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
      </if>
      <if test = "category.equals('content')">
        AND content LIKE CONCAT ('%', #{value}, '%')
        AND bname IN ('CAMREVIEW', 'TSREVIEW', 'RESTREVIEW', 'RESELL', 'FREE')
      </if>
  </select>

  <!-- 회원 게시판 게시글 삭제 -->
  <update id="bbsDel" parameterType="String">
    UPDATE bbs SET status = 2
    WHERE b_idx = #{b_idx}    
  </update>

  <!-- 강제 삭제한 게시물 여부 확인-->
  <select id="bbsDelChk" parameterType="String" resultType="int">
    SELECT COUNT(*) FROM bbs
    WHERE b_idx = #{b_idx} AND status = 2
  </select>
</mapper>
