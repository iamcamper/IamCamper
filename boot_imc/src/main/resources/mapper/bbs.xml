<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iamcamper.boot_imc.mapper.BbsMapper">
    <resultMap type="com.iamcamper.boot_imc.VO.BbsVO" id="map1">
		<id property="b_idx" column="b_idx"/>
		<collection property="c_list" ofType="com.iamcamper.boot_imc.VO.CommVO"
				select="com.iamcamper.boot_imc.mapper.CommMapper.commList" column="b_idx"/>
	</resultMap>
	
	<select id="list" resultMap="map1" 
		parameterType="Map">
		SELECT a.* FROM(
			SELECT @RN:=@RN+1 AS rownnum, b.* 
			FROM (SELECT * FROM bbs
					WHERE status = 0 ORDER BY b_idx DESC) b, (SELECT @RN:=0) r
		) a
		WHERE (rownnum BETWEEN #{begin} AND #{end}) AND bname = #{bname}
	</select>
    <insert id="add" parameterType="com.iamcamper.boot_imc.VO.BbsVO">
		INSERT INTO bbs(subject, nickname, content, file_name, ori_name, thum_img, write_date, ip, bname, price)
   		VALUES (#{subject}, #{nickname}, #{content}, #{file_name}, #{ori_name}, #{thum_img}, NOW(), #{ip}, #{bname}, #{price})
	</insert>
	
	<!-- 원글 검색 -->
	<select id="view" resultMap="map1" parameterType="String">
		SELECT * FROM bbs
		WHERE b_idx = #{b_idx}
	</select>
	
	<!-- 원글 수정 -->
	<update id="edit" parameterType="java.util.Map">
		UPDATE bbs
		<trim prefix="SET" suffixOverrides=",">
			<if test="subject != null">
				subject = #{subject},
			</if>
			<if test="content != null">
				content = #{content},
			</if>
			<if test="fname != null">
				file_name = #{file_name},
				ori_name = #{ori_name},
			</if>
		</trim>
		WHERE b_idx = #{b_idx}
	</update>
	<update id="del" parameterType="String">
		UPDATE bbs
		SET status = 1
		WHERE b_idx = #{b_idx}
	</update>
	
	<!-- 베스트 중고거래 글 불러오기 -->
	<select id="blist" resultType="com.iamcamper.boot_imc.VO.BbsVO"  parameterType="String">
		SELECT a.* FROM(
			SELECT @RN:=@RN+1 AS rownnum, b.* 
			FROM (SELECT * FROM bbs
					WHERE status = 0 AND bname= #{bname} ORDER BY hit DESC) b, (SELECT @RN:=0) r) a
			WHERE rownnum BETWEEN '1' AND '10'
	</select>
	<!-- 베스트 글 불러오기 -->
	<select id="blist2" resultType="com.iamcamper.boot_imc.VO.BbsVO"  parameterType="java.util.Map">
		SELECT a.* FROM(
			SELECT @RN:=@RN+1 AS rownnum, b.* 
			FROM (SELECT * FROM bbs
					WHERE status = 0 AND bname = #{bname1} or bname = #{bname2} or bname = #{bname3} ORDER BY hit DESC) b, (SELECT @RN:=0) r) a
			WHERE rownnum BETWEEN '1' AND '10'
	</select>

	<select id="totalCount" resultType="int" parameterType="String">
    SELECT COUNT(*) FROM bbs
    WHERE bname = #{bname} AND status = 0
    </select>

	<update id="ViewCount">
    UPDATE bbs
    SET hit = hit + 1
    WHERE b_idx = #{b_idx}
</update>
</mapper>